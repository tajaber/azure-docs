---
title: Malware Scanning in Defender for Storage
description: Learn about the benefits and features of malware scanning in Microsoft Defender for Storage.
ms.date: 03/16/2023
author: dcurwin
ms.author: dacurwin
ms.topic: how-to
---

# Malware Scanning in Defender for Storage

Malware Scanning in Defender for Storage helps protect your storage accounts from malicious content by performing a full malware scan on uploaded content in near real time, using Microsoft Defender Antivirus capabilities. It's designed to help fulfill security and compliance requirements for handling untrusted content.

The Malware Scanning capability is an agentless SaaS solution that allows simple setup at scale, with zero maintenance, and supports automating response at scale.

:::image type="content" source="media/defender-for-storage-malware-scan/malware-scanning.png" alt-text="Diagram showing how malware scanning protects your data from malicious code.":::

## Malware upload is a top threat on cloud storage

Content uploaded to cloud storage could be malware. Storage accounts can be a malware entry point into the organization and a malware distribution point. To protect organizations from this threat, content in cloud storage must be scanned for malware before it's accessed.

## Malware Scanning in Defender for Storage helps protect storage accounts from malicious content

- A built-in SaaS solution that allows simple enabling at scale with zero maintenance.

- Comprehensive antimalware capabilities using Microsoft Defender Antivirus (MDAV), catching polymorphic and metamorphic malware.

- Every file type is scanned (including archives like zip files) and a result is returned for every scan. The file size limit is 2 GB.

- Supports response at scale – deleting or quarantining suspicious files, based on the blobs’ index tags or Event Grid events.

- When the malware scan identifies a malicious file, detailed Microsoft Defender for Cloud security alerts are generated.
- Designed to help fulfill security and compliance requirements to scan untrusted content uploaded to storage, including an option to log every scan result.

## Common use-cases and scenarios

Some common use-cases and scenarios for Malware Scanning in Defender for Storage include:

- To protect storage accounts from malicious content, especially when content in the storage account is uploaded from untrusted sources (customers and partners, anonymous users, etc.)

- To comply with compliance standards that require on-upload malware scanning for noncompute resources (NIST, SWIFT, UK GOV, and more), and collecting the necessary evidence for compliance audits.

## Prerequisites

You can [enable and configure Malware Scanning at scale](../storage/common/azure-defender-storage-configure.md#configure-malware-scanning) for your subscriptions while maintaining granular control over configuring the feature for individual storage accounts. To set up and customize Malware Scanning in Defender for Storage, you can choose from various methods, including the Azure portal, Azure policy, ARM or Bicep templates, and REST API.

To enable and configure Malware Scanning, you must have Owner roles (such as Subscription Owner or Storage Account Owner) or specific roles with the necessary data actions. Learn more about the [required permissions](support-matrix-defender-for-storage.md).

## How does Malware Scanning work?

### Set up of Malware Scanning

When Malware Scanning is enabled, the following actions automatically take place in your environment:

- For each storage account you enable Malware Scanning on, an Event Grid System Topic resource is created in the same resource group of the storage account - used by the Malware Scanning service to listen on blob upload triggers. Removing this resource breaks the Malware Scanning functionality.

- To scan your data, the Malware Scanning service requires access to your data. During service enablement, a new Data Scanner resource called **StorageDataScanner** is created in your Azure subscription and assigned with a system-assigned managed identity. This resource is granted with the **Storage** **Blob Data Owner** role assignment permitting it to access your data for purposes of Malware Scanning and Sensitive Data Discovery.

In case your storage account **Networking configuration** is set to **Enable Public network access from selected virtual networks and IP addressed**, the **StorageDataScanner** resource is added to the **Resource instances** section under storage account **Networking** configuration to allow access to scan your data.

In case you're enabling Malware Scanning on the subscription level, a new Security Operator resource called **StorageAccounts/securityOperators/DefenderForStorageSecurityOperator** is created in your Azure subscription and assigned with a system-managed identity. This resource is used to enable and repair Defender for Storage and Malware Scanning configuration on existing storage accounts and check for new storage accounts created in the subscription to be enabled. This resource has role assignments that include the [specific permissions](#prerequisites) needed to enable Malware Scanning.

> [!NOTE]
> Malware Scanning depends on certain resources, identities, and networking settings to function properly. If you modify or delete any of these, Malware Scanning will stop working. To restore its normal operation, you can turn it off and on again.

### On-upload malware scanning

#### On-upload triggers

When a blob is uploaded to a protected storage account - a malware scan is triggered. All upload methods trigger the scan. Modifying a blob is an upload operation and therefore the modified content is scanned after the update.

#### Scan regions and data retention

The blob is read by the Malware Scanning service that uses Microsoft Defender Antivirus technologies.
The malware scanning is regional, the scanned content stays within the same region. The content isn't saved by the service, it's scanned "in-memory" and immediately deleted afterward.

#### Access customer data

The Malware Scanning service requires access to your data to scan your data for malware. During service enablement, a new Data Scanner resource called **StorageDataScanner** is created in your Azure subscription. This resource is granted with a **Storage Blob Data Owner** role assignment to access and change your data for Malware Scanning and Sensitive Data Discovery.

#### Private Endpoint is supported out-of-the-box
Malware Scanning in Defender for Storage is supported in storage accounts that use private endpoints while maintaining data privacy. 

[Private endpoints](../private-link/private-endpoint-overview.md) provide secure connectivity to your Azure storage services, eliminating public internet exposure, and are considered a best practice.

## Providing scan results

Malware Scanning scan results are available through four methods. After setup, you'll see scan results as **blob index tags** for every uploaded and scanned file in the storage account, and as **Microsoft Defender for Cloud security alerts** when a file is identified as malicious.

You may choose to configure extra scan result methods, such as **Event Grid** and **Log Analytics**, which require extra configuration. In the next section, you'll learn about the different scan result methods.

## Scan results

### Blob index tags

[Blob index tags](../storage/blobs/storage-blob-index-how-to.md) are metadata fields on a blob. They categorize data in your storage account using key-value tag attributes. These tags are automatically indexed and exposed as a searchable multi-dimensional index to easily find data. The scan results are concise, displaying **Malware Scanning scan result** and **Malware Scanning scan time UTC** in the blob metadata. Other result types (alerts, events, logs) provide more information on the malware type and file upload operation.

Malware Scanning Index Tags Keys added:

- Malware Scanning scan result possible values:

    - `No threats found`
    - `Malicious`
    - `SAM259210: Scan aborted - <message> Correlation Id: <correlation-id-guid>`
    - `SAM259210: Scan failed - <message> Correlation Id: <correlation-id-guid>`
    - `SAM259210: Scan timed out - <message> Correlation Id: <correlation-id-guid>`
        If there are issues, you can provide this `<correlation-id-guid>` to Microsoft support for troubleshooting.

- Malware Scanning scan time UTC possible values:

    - The time and date of the scan. Format: yyyy-MM-dd HH:mm:ssZ

Blob index tags can be used by applications to automate workflows. Read more on [setting up response](defender-for-storage-configure-malware-scan.md).

### Defender for Cloud security alerts

When a malicious file is detected, Microsoft Defender for Cloud generates a [Microsoft Defender for Cloud security alert](alerts-overview.md#what-are-security-alerts). To see the alert, go to **Microsoft Defender for Cloud** security alerts.
The security alert contains details and context on the file, the malware type, and recommended investigation and remediation steps. To use these alerts for remediation, you can:

1. View [security alerts](https://portal.azure.com/#view/Microsoft_Azure_Security/SecurityMenuBlade/~/7) in the Azure portal by navigating to Microsoft Defender for Cloud -> Security alerts
1. [Configure automations](workflow-automation.md) based on these alerts.
1. [Export security alerts](alerts-overview.md#exporting-alerts) to a SIEM. You can continuously export security alerts Microsoft Sentinel (Microsoft’s SIEM) using [Microsoft Sentinel connector](../sentinel/connect-defender-for-cloud.md), or another SIEM of your choice.

Learn more about [responding to security alerts](../event-grid/custom-event-quickstart-portal.md#subscribe-to-custom-topic).

### Event Grid event

Event Grid is useful for event-driven automation. It's the fastest method to get results with minimum latency in a form of events that you can use for automating response.

Events from Event Grid custom topics can be consumed by multiple endpoint types.
The most useful for Malware Scanning scenarios are:

- Function App (previously called Azure Function) – use a serverless function to run code for automated response like move, delete or quarantine.
- Web Hook – to connect an application.
- Event Hubs & Service Bus Queue – to notify downstream consumers.

For each scan result, an event is sent using the schema below.

__Event Message Structure__

The event message is a JSON object that contains key-value pairs that provide detailed information about a malware scanning result. Here's a breakdown of each key in the event message:

- __id__: A unique identifier for the event.

- __subject__: A string that describes the resource path of the scanned blob (file) in the storage account.

- __data__: A JSON object that contains additional information about the event:

   - __correlationId__: A unique identifier that can be used to correlate multiple events related to the same scan.

   - __blobUri__: The URI of the scanned blob (file) in the storage account.

   - __eTag__: The ETag of the scanned blob (file).

   - __scanFinishedTimeUtc__: The UTC timestamp when the scan was completed.

   - __scanResultType__: The result of the scan, e.g., "Malicious" or "No threats found".

   - __scanResultDetails__: A JSON object containing details about the scan result:

      1. __malwareNamesFound__: An array of malware names found in the scanned file.

      1. __sha256__: The SHA-256 hash of the scanned file.

- __eventType__: A string that indicates the type of event, in this case, "Microsoft.Security.MalwareScanningResult".

- __dataVersion__: The version number of the data schema.

- __metadataVersion__: The version number of the metadata schema.

- __eventTime__: The UTC timestamp when the event was generated.

- __topic__: The resource path of the Event Grid topic that the event belongs to.

Here's an example of an event message:


```json

{
  "id": "52d00da0-8f1a-4c3c-aa2c-24831967356b",
  "subject": "storageAccounts/<storage_account_name>/containers/app-logs-storage/blobs/EICAR - simulating malware.txt",
  "data": {
    "correlationId": "52d00da0-8f1a-4c3c-aa2c-24831967356b",
    "blobUri": "https://<storage_account_name>.blob.core.windows.net/app-logs-storage/EICAR - simulating malware.txt",
    "eTag": "0x8DB4C9327B08CBF",
    "scanFinishedTimeUtc": "2023-05-04T11:31:54.0481279Z",
    "scanResultType": "Malicious",
    "scanResultDetails": {
      "malwareNamesFound": [
        "DOS/EICAR_Test_File"
      ],
      "sha256": "275A021BBFB6489E54D471899F7DB9D1663FC695EC2FE2A2C4538AABF651FD0F"
    }
  },
  "eventType": "Microsoft.Security.MalwareScanningResult",
  "dataVersion": "1.0",
  "metadataVersion": "1",
  "eventTime": "2023-05-04T11:31:54.048375Z",
  "topic": "/subscriptions/<subscription_id>/resourceGroups/<resource_group_name>/providers/Microsoft.EventGrid/topics/<event_grid_topic_name>"
}
```

By understanding the structure of the event message, you can extract relevant information about the malware scanning result and process it accordingly.

Learn how to configure Malware Scanning so that [every scan result is sent automatically to an Event Grid topic](../storage/common/azure-defender-storage-configure.md#setting-up-event-grid-for-malware-scanning) for automation purposes.

### Logs Analytics

You may want to log your scan results for compliance evidence or investigating scan results. By setting up a Log Analytics Workspace destination, you can store every scan result in a centralized log repository that is easy to query. You can view the results by navigating to the Log Analytics destination workspace and looking for the `StorageMalwareScanningResults` table.

Learn more about [setting up Log Analytics results](../azure-monitor/logs/quick-create-workspace.md).

## Cost control

Malware Scanning is billed per GB scanned. To provide cost predictability, Malware Scanning supports setting a cap on the amount of GB scanned in a single month per storage account. This setting can be set at the subscription level to apply to each storage account in the subscription, or you can set it for a specific storage account. The default value for each storage account is 5000GB per month, and after crossing this limit, blobs won't be scanned (with up to a 20-GB confidence interval). Learn about how to [configure scan limits](../storage/common/azure-defender-storage-configure.md#configure-malware-scanning).

## Handling possible false positives

If you have a file that you suspect might be malware or is being incorrectly detected, you can submit it to us for analysis through [the sample submission portal](https://aka.ms/submitfile). Select “Microsoft Defender for Storage” as the source.

Malware Scanning doesn't block access or change permissions to the uploaded blob, even if it's malicious.

## Limitations

### Unsupported features and services

1. **Unsupported storage accounts:** Legacy v1 storage accounts aren't supported by Malware Scanning.

1. **Unsupported service:** Azure Files isn't supported by Malware Scanning.

1. **Unsupported blob types:** [Append and Page blobs](/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs) aren't supported for Malware Scanning.

1. **Unsupported encryption:** Client-side encrypted blobs aren't supported as they can't be decrypted before scanning by the service. However, data encrypted at rest by Customer Managed Key (CMK) is supported.

1. **Unsupported index tag results:** Index tag scan result isn't supported in storage accounts with Hierarchical namespace enabled (Azure Data Lake Storage Gen2).

### Throughput capacity and blob size limit

1. **Scan throughput rate limit:** Malware Scanning can process up to 2GB per minute for each storage account. If the rate of file upload momentarily exceeds this threshold for a storage account, the system will attempt to scan the files in excess of the rate limit. If the rate of file upload consistently exceeds this threshold, some blobs will not be scanned.

1. **Blob scan limit:** Malware Scanning can process up to 2,000 files per minute for each storage account. If the rate of file upload momentarily exceeds this threshold for a storage account, the system will attempt to scan the files in excess of the rate limit. If the rate of file upload consistently exceeds this threshold, some blobs will not be scanned.

1. **Blob size limit:** The maximum size limit for a single blob to be scanned is 2 GB. Blobs that are larger than the limit will not be scanned.

### Blob uploads and index tag updates

Upon uploading a blob to the storage account, the Malware Scanning will initiate an additional read operation and update the index tag. In most cases, these operations do not generate significant load.

### Impact on access and storage IOPS

Despite the scanning process, access to uploaded data remains unaffected, and the impact on storage Input/Output Operations Per Second (IOPS) is minimal.

## Next steps

In this article, you learned about Microsoft Defender for Storage.

> [!div class="nextstepaction"]
> [Enable Defender for Storage](enable-enhanced-security.md)






























