---
title: Setting up response to Malware Scanning
description: Learn about how to configure response to malware scanning to prevent harmful files from being uploaded to Azure Storage.
ms.date: 03/16/2023
author: dcurwin
ms.author: dacurwin
ms.topic: how-to
---

# Setting up response to Malware Scanning

Set up automated responses to move or remove malicious files or to move/ingest clean files to another destination. Select the preferred response option that fits your scenario architecture.  

With Malware Scanning, you can build your automation response using the following scan result option: 

- Defender for Cloud security alerts
- Event Grid events
- Blob index tags

Here are some response options that you can use to automate your response:

## Delete or move a malicious blob

You can use code or workflow automation to delete or move malicious files to quarantine.

### Prepare your environment for delete or move.

- **Delete the malicious file** - Before setting up automated deletion, enabling [soft delete](../storage/blobs/soft-delete-blob-overview.md) on the storage account is recommended. It allows to “undelete” files if there are false positives or in cases where security professionals want to investigate the malicious files.

- **Move the malicious file to quarantine** - You can move files to a dedicated storage container or storage account that are considered as “quarantine”.
You may want only certain users, such as a security admin or a SOC analyst, to have permission to access this dedicated container or storage account.
    - Using [Azure Active Directory (Azure AD) to control access to blob storage](../storage/blobs/authorize-access-azure-active-directory.md) is considered a best practice. To control access to the dedicated quarantine storage container, you can use [container-level role assignments using Azure AD Role-based access control (RBAC)](../storage/blobs/authorize-access-azure-active-directory.md). Users with storage account-level permissions may still be able to access the “quarantine” container. You can either edit their permissions to be container-level or choose a different approach and move the malicious file to a dedicated storage account.
    - If you must use other methods, such as [SAS (shared access signatures)](../storage/common/storage-sas-overview.md) tokens on the protected storage account, it's best practice to move malicious files to another storage account (quarantine). Then, it's best only to grant Azure AD permission to access the quarantined storage account.

### Set up automation

#### Option 1: Logic App based on Microsoft Defender for Cloud security alerts

Logic App based responses are a simple, no-code approach to setting up response. However, the response time is slower than the event-driven code-based approach.

1. Deploy the [DeleteBlobLogicApp](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fstorageantimalwareprev.blob.core.windows.net%2Fworkflows%2FDeleteBlobLogicApp-template.json) Azure Resource Manager (ARM) template using the Azure portal.

1. Add role assignment to the Logic App to allow it to delete blobs from your storage account:
    1. Go to **Identity** in the side menu and select on **Azure role assignments**.
        :::image type="content" source="media/defender-for-storage-configure-malware-scan/storage-account-malware-response-1.png" alt-text="Screenshot showing how to set up a role assignment for workflow automation to respond to scan results.":::
    1. Add role assignment in the subscription level with the **Storage Blob Data Contributor** role.
        :::image type="content" source="media/defender-for-storage-configure-malware-scan/storage-account-malware-response-2.png" alt-text="Screenshot showing how to set up the required role assignment for workflow automation to respond to scan results.":::
    1. Create workflow automation for Microsoft Defender for Cloud alerts:

        1. Go to **Microsoft Defender for Cloud** in the Azure portal.
        
        1. Go to **Workflow automation** in the side menu.
        1. Add a new workflow. In the **Alert name contains** field, fill in **Malicious file uploaded to storage account** and choose your Logic app in the **Actions** section.

        :::image type="content" source="media/defender-for-storage-configure-malware-scan/storage-account-malware-response-3.png" alt-text="Screenshot showing how to set up workflow automation to respond to scan results.":::

#### Option 2: Function App based on Event Grid events

A Function App provides high performance with a low latency response time.

1. Create a [Function App](../azure-functions/functions-overview.md) in the same resource group as your protected storage account.

1. Add role assignment for the Function app identity.

    1. Go to **Identity** in the side menu, make sure the **System assigned** identity status is **ON**, and select on **Azure role assignments**.

    1. Add role assignment in the subscription or storage account levels with the **Storage Blob Data Contributor** role.

1. Consume Event Grid events and connect an Azure Function as the endpoint type.

1. When writing the Azure Function code, you can use our premade function sample - [MoveMaliciousBlobEventTrigger](https://storageantimalwareprev.blob.core.windows.net/samples/MoveMaliciousBlobEventTrigger.cs), or [write your own code](../storage/blobs/storage-blob-copy.md) to copy the blob elsewhere, then delete it from the source.

## Make your applications and data flows aware of Malware Scanning scan results

Malware Scanning is near real-time, and usually, there's a small time window between the time of the upload and the time of the scan.  
Because storage is noncompute, there's no risk that malicious files are executed in your storage. The risk is users or applications accessing malicious files and spreading them throughout the organization.

There are a few methods to make your applications and data flows aware of Malware Scanning scan results and ensure there's no way to access/process a file before it has been scanned and its result has been consumed and acted on.

### Applications ingest data based on the scan result

#### Option 1: Apps checking “Index tag” before processing

One way to get ingest data is to update all the applications that access the storage account. Each application checks the scan result for each file, and if the blob **Index tag** scan result is **no threats found**, the application reads the blob.

#### Option 2: Connect your application to a Webhook in Event Grid events

You can connect your application to a Webhook in Event Grid events and use those events to trigger the relevant processes for files that have **no threats found** scan results.
Learn more about using [Webhook event delivery and validating your endpoint](../event-grid/webhook-event-delivery.md).

### Use an intermediary storage account as a DMZ

You can set up an intermediary storage account for untrusted content (DMZ) and direct uploading traffic to the DMZ.  
On the untrusted storage account, enable Malware Scanning and connect Event Grid and Function App to move only blobs scanned with the “no threat found” result to the destination storage account.

:::image type="content" source="media/defender-for-storage-configure-malware-scan/storage-account-malware-response-4.png" alt-text="Diagram showing how to set up an intermediary storage account as a DMZ.":::

## Next steps

In this article, you learned about Microsoft Defender for Storage.

> [!div class="nextstepaction"]
> [Enable Defender for Storage](enable-enhanced-security.md)
